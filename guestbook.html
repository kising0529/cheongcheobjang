<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°©ëª…ë¡ | ë‚˜ë§Œì˜ ì²­ì²©ì¥</title>
  <link rel="stylesheet" href="guestbook.css">
</head>
<body>
  <div class="guestbook-container">
    <h1>ğŸŒ¸ ë°©ëª…ë¡</h1>
    <form id="guestbook-form">
      <div class="form-row">
        <label for="guest-name">ì´ë¦„</label>
        <input type="text" id="guest-name" name="guest-name" required maxlength="12">
      </div>
      <div class="form-row">
        <label for="guest-msg">ì¶•í•˜ ë©”ì‹œì§€</label>
        <textarea id="guest-msg" name="guest-msg" rows="3" required maxlength="200" placeholder="ì¶•í•˜ì˜ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!"></textarea>
      </div>
      <button type="submit">ë©”ì‹œì§€ ë‚¨ê¸°ê¸°</button>
    </form>
    <div id="guestbook-message"></div>
    <div class="guestbook-list" id="guestbook-list">
      <!-- ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ê°€ JSë¡œ ë Œë”ë§ë¨ -->
    </div>
  </div>
  <script type="module">
    import { supabase } from './supabase.js';

    // ê¸ˆì¹™ì–´(ê°„ë‹¨ ì˜ˆì‹œ)
    const BAD_WORDS = ['ìš•ì„¤1', 'ìš•ì„¤2', 'fuck', 'shit'];
    function hasBadWord(msg) {
      return BAD_WORDS.some(word => msg.includes(word));
    }

    // ì´ˆëŒ€ì¥ ê³ ìœ ì½”ë“œ(ì¿¼ë¦¬ìŠ¤íŠ¸ë§)
    const inviteId = new URLSearchParams(window.location.search).get('id') || 'abcd1234';
    // ë¡œê·¸ì¸ ìœ ì €(ì‚­ì œ ê¶Œí•œìš©, ì‹¤ì œ êµ¬í˜„ì‹œ supabase.auth.user() ë“± í™œìš©)
    let currentUser = null;
    try {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
    } catch {}
    // ì²­ì²©ì¥ ì£¼ì¸ id(ì‹¤ì œ êµ¬í˜„ì‹œ supabaseì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
    let ownerId = null;
    async function fetchOwnerId() {
      const { data } = await supabase.from('invitations').select('created_by').eq('id', inviteId).single();
      ownerId = data ? data.created_by : null;
    }
    await fetchOwnerId();

    // ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    async function loadGuestbook() {
      const listDiv = document.getElementById('guestbook-list');
      listDiv.innerHTML = '<div style="color:#b07a8c;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      const { data, error } = await supabase
        .from('guestbook')
        .select('*')
        .eq('invite_id', inviteId)
        .order('created_at', { ascending: false });
      if (error) {
        listDiv.innerHTML = '<div style="color:#c06c8c;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
        return;
      }
      if (!data || data.length === 0) {
        listDiv.innerHTML = '<div style="color:#b07a8c;">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      listDiv.innerHTML = '';
      data.forEach(msg => {
        const item = document.createElement('div');
        item.className = 'guestbook-item';
        item.innerHTML = `
          <div class="guest-name">${msg.name}</div>
          <div class="guest-msg">${msg.message}</div>
          <div class="guest-date">${new Date(msg.created_at).toLocaleString('ko-KR')}</div>
        `;
        // ì‚­ì œ ë²„íŠ¼(ë³¸ì¸/ì£¼ì¸ë§Œ)
        if (currentUser && (currentUser.id === msg.user_id || currentUser.id === ownerId)) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'ì‚­ì œ';
          delBtn.onclick = async () => {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              await supabase.from('guestbook').delete().eq('id', msg.id);
              loadGuestbook();
            }
          };
          item.appendChild(delBtn);
        }
        listDiv.appendChild(item);
      });
    }

    // ë©”ì‹œì§€ ì‘ì„±/ì €ì¥
    const form = document.getElementById('guestbook-form');
    const messageDiv = document.getElementById('guestbook-message');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.textContent = '';
      const name = form['guest-name'].value.trim();
      const message = form['guest-msg'].value.trim();
      if (!name || !message) {
        messageDiv.textContent = 'ì´ë¦„ê³¼ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
        return;
      }
      if (hasBadWord(message)) {
        messageDiv.textContent = 'ë¶€ì ì ˆí•œ ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
        return;
      }
      // supabase ì €ì¥
      const { error } = await supabase.from('guestbook').insert([{
        invite_id: inviteId,
        name,
        message,
        user_id: currentUser ? currentUser.id : null,
        created_at: new Date().toISOString()
      }]);
      if (error) {
        messageDiv.textContent = 'ë©”ì‹œì§€ ì €ì¥ ì‹¤íŒ¨: ' + error.message;
        return;
      }
      form.reset();
      messageDiv.textContent = 'ë©”ì‹œì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
      loadGuestbook();
    });

    // ìµœì´ˆ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
    loadGuestbook();
  </script>
</body>
</html> 