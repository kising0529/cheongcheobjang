<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì²­ì²©ì¥ ë§Œë“¤ê¸° | ë‚˜ë§Œì˜ ì²­ì²©ì¥</title>
  <link rel="stylesheet" href="create-invite.css">
</head>
<body>
  <div class="invite-form-container">
    <h1>ğŸ’Œ ì²­ì²©ì¥ ë§Œë“¤ê¸°</h1>
    <form id="invite-form" enctype="multipart/form-data">
      <div class="form-row">
        <label for="groom-name">ì‹ ë‘ ì´ë¦„</label>
        <input type="text" id="groom-name" name="groom-name" required>
      </div>
      <div class="form-row">
        <label for="groom-phone">ì‹ ë‘ ì—°ë½ì²˜</label>
        <input type="tel" id="groom-phone" name="groom-phone" required>
      </div>
      <div class="form-row">
        <label for="bride-name">ì‹ ë¶€ ì´ë¦„</label>
        <input type="text" id="bride-name" name="bride-name" required>
      </div>
      <div class="form-row">
        <label for="bride-phone">ì‹ ë¶€ ì—°ë½ì²˜</label>
        <input type="tel" id="bride-phone" name="bride-phone" required>
      </div>
      <div class="form-row">
        <label for="wedding-date">ê²°í˜¼ ë‚ ì§œ</label>
        <input type="date" id="wedding-date" name="wedding-date" required>
      </div>
      <div class="form-row">
        <label for="wedding-time">ê²°í˜¼ ì‹œê°„</label>
        <input type="time" id="wedding-time" name="wedding-time" required>
      </div>
      <div class="form-row">
        <label for="venue-name">ì˜ˆì‹ì¥ ì´ë¦„</label>
        <input type="text" id="venue-name" name="venue-name" required>
      </div>
      <div class="form-row">
        <label for="venue-address">ì˜ˆì‹ì¥ ì£¼ì†Œ</label>
        <input type="text" id="venue-address" name="venue-address" required>
      </div>
      <div class="form-row">
        <label for="venue-map">ì˜ˆì‹ì¥ ì§€ë„ ë§í¬</label>
        <input type="url" id="venue-map" name="venue-map" placeholder="https://map.kakao.com/...">
      </div>
      <div class="form-row">
        <label for="show-account">
          <input type="checkbox" id="show-account" name="show-account"> ê³„ì¢Œë²ˆí˜¸ í‘œì‹œ
        </label>
      </div>
      <div class="form-row account-row" style="display:none;">
        <label for="account-info">ê³„ì¢Œë²ˆí˜¸</label>
        <input type="text" id="account-info" name="account-info" placeholder="ì€í–‰ëª… 000-0000-0000 ì˜ˆê¸ˆì£¼">
      </div>
      <div class="form-row">
        <label for="main-photo">ëŒ€í‘œ ì‚¬ì§„ ì—…ë¡œë“œ</label>
        <input type="file" id="main-photo" name="main-photo" accept="image/*">
        <div id="photo-preview"></div>
      </div>
      <div class="form-row">
        <label>ì´ˆëŒ€ ë©”ì‹œì§€</label>
        <div class="msg-toggle-row">
          <input type="radio" id="msg-auto" name="msg-type" value="auto" checked>
          <label for="msg-auto">ìë™ ìƒì„±</label>
          <input type="radio" id="msg-custom" name="msg-type" value="custom">
          <label for="msg-custom">ì§ì ‘ ì…ë ¥</label>
        </div>
        <textarea id="invite-msg" name="invite-msg" rows="4" placeholder="ì´ˆëŒ€ ë©”ì‹œì§€" disabled></textarea>
      </div>
      <button type="submit">ì²­ì²©ì¥ ìƒì„±</button>
    </form>
    <div id="invite-message"></div>
  </div>
  <script type="module">
    import { supabase } from './supabase.js';

    // ê³„ì¢Œë²ˆí˜¸ í‘œì‹œ ì²´í¬ ì‹œ ì…ë ¥ë€ show/hide
    const showAccount = document.getElementById('show-account');
    const accountRow = document.querySelector('.account-row');
    showAccount.addEventListener('change', () => {
      accountRow.style.display = showAccount.checked ? 'flex' : 'none';
    });

    // ëŒ€í‘œ ì‚¬ì§„ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸°
    const mainPhoto = document.getElementById('main-photo');
    const photoPreview = document.getElementById('photo-preview');
    mainPhoto.addEventListener('change', (e) => {
      photoPreview.innerHTML = '';
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = document.createElement('img');
          img.src = ev.target.result;
          photoPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // ì´ˆëŒ€ ë©”ì‹œì§€ ìë™/ì§ì ‘ì…ë ¥ í† ê¸€
    const msgAuto = document.getElementById('msg-auto');
    const msgCustom = document.getElementById('msg-custom');
    const inviteMsg = document.getElementById('invite-msg');
    function setAutoMsg() {
      // ìë™ ë©”ì‹œì§€ ìƒ˜í”Œ ìƒì„± (ê°„ë‹¨ ì˜ˆì‹œ)
      const groom = document.getElementById('groom-name').value || 'ì‹ ë‘';
      const bride = document.getElementById('bride-name').value || 'ì‹ ë¶€';
      const date = document.getElementById('wedding-date').value;
      const venue = document.getElementById('venue-name').value || 'ì˜ˆì‹ì¥';
      let msg = `${groom}ì™€(ê³¼) ${bride}ì˜ ê²°í˜¼ì‹ì— ì†Œì¤‘í•œ ë°œê±¸ìŒì„ ì´ˆëŒ€í•©ë‹ˆë‹¤.\n\nì¼ì‹œ: ${date}\nì¥ì†Œ: ${venue}`;
      inviteMsg.value = msg;
    }
    msgAuto.addEventListener('change', () => {
      if (msgAuto.checked) {
        inviteMsg.disabled = true;
        setAutoMsg();
      }
    });
    msgCustom.addEventListener('change', () => {
      if (msgCustom.checked) {
        inviteMsg.disabled = false;
        inviteMsg.value = '';
      }
    });
    // ìë™ ë©”ì‹œì§€ ê°’ ì‹¤ì‹œê°„ ë°˜ì˜
    ['groom-name','bride-name','wedding-date','venue-name'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        if (msgAuto.checked) setAutoMsg();
      });
    });
    // ìµœì´ˆ ìë™ ë©”ì‹œì§€ ì„¸íŒ…
    setAutoMsg();

    // ëŒ€í‘œ ì‚¬ì§„ ì—…ë¡œë“œ í•¨ìˆ˜
    async function uploadPhoto(file, inviteId) {
      const ext = file.name.split('.').pop();
      const filePath = `invites/${inviteId}/main.${ext}`;
      const { data, error } = await supabase.storage.from('invite-photos').upload(filePath, file, { upsert: true });
      if (error) throw error;
      // public URL ìƒì„±
      const { data: urlData } = supabase.storage.from('invite-photos').getPublicUrl(filePath);
      return urlData.publicUrl;
    }

    // ê³ ìœ  ì½”ë“œ ìƒì„± í•¨ìˆ˜
    function generateInviteId() {
      return Math.random().toString(36).substr(2, 8);
    }

    // í¼ ì œì¶œ ì‹œ supabase ì €ì¥ ë¡œì§ ì¶”ê°€
    const form = document.getElementById('invite-form');
    const messageDiv = document.getElementById('invite-message');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.textContent = '';
      // ê¸°ì¡´ ê²€ì¦
      if (showAccount.checked && !form['account-info'].value.trim()) {
        messageDiv.textContent = 'ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
        return;
      }
      if (msgCustom.checked && !inviteMsg.value.trim()) {
        messageDiv.textContent = 'ì´ˆëŒ€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
        return;
      }
      // ê³ ìœ  ì½”ë“œ ìƒì„±
      const inviteId = generateInviteId();
      // ëŒ€í‘œ ì‚¬ì§„ ì—…ë¡œë“œ
      let mainPhotoUrl = '';
      const file = mainPhoto.files[0];
      if (file) {
        messageDiv.textContent = 'ëŒ€í‘œ ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...';
        try {
          mainPhotoUrl = await uploadPhoto(file, inviteId);
        } catch (err) {
          messageDiv.textContent = 'ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
          return;
        }
      }
      // template_idëŠ” localStorageì—ì„œ ë¶ˆëŸ¬ì˜¨ë‹¤ê³  ê°€ì •
      const templateId = localStorage.getItem('selectedTemplateId') || 'classic';
      // supabase invitations í…Œì´ë¸”ì— ì €ì¥
      messageDiv.textContent = 'ì²­ì²©ì¥ ì €ì¥ ì¤‘...';
      const { error } = await supabase.from('invitations').insert([{
        id: inviteId,
        groom_name: form['groom-name'].value,
        groom_phone: form['groom-phone'].value,
        bride_name: form['bride-name'].value,
        bride_phone: form['bride-phone'].value,
        wedding_date: form['wedding-date'].value,
        wedding_time: form['wedding-time'].value,
        venue_name: form['venue-name'].value,
        venue_address: form['venue-address'].value,
        venue_map: form['venue-map'].value,
        show_account: showAccount.checked,
        account_info: form['account-info'].value,
        main_photo_url: mainPhotoUrl,
        invite_msg: inviteMsg.value,
        template_id: templateId,
        created_at: new Date().toISOString()
      }]);
      if (error) {
        messageDiv.textContent = 'ì²­ì²©ì¥ ì €ì¥ ì‹¤íŒ¨: ' + error.message;
        return;
      }
      // ìƒì„± ì™„ë£Œ ì•ˆë‚´ ë° ë¯¸ë¦¬ë³´ê¸°(ê°„ë‹¨ ë©”ì‹œì§€)
      messageDiv.innerHTML = `ì²­ì²©ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ê³ ìœ  URL: <a href="/invite/${inviteId}" target="_blank">/invite/${inviteId}</a>`;
      form.reset();
      photoPreview.innerHTML = '';
      setAutoMsg();
      accountRow.style.display = 'none';
    });
  </script>
</body>
</html> 